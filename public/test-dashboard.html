<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>anky test dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      :root {
        --bg: #0a0a0b;
        --card: #111113;
        --border: #1f1f23;
        --fg: #fafafa;
        --muted: #71717a;
        --gold: #fbbf24;
        --purple: #a78bfa;
        --green: #4ade80;
        --red: #f87171;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--bg);
        color: var(--fg);
        height: 100vh;
        overflow: hidden;
      }

      /* Layout */
      .dashboard {
        display: grid;
        grid-template-columns: 1fr 300px 1fr;
        gap: 1px;
        height: 100vh;
        background: var(--border);
      }
      .panel {
        background: var(--bg);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .panel-header {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      /* Left Panel - Input */
      .input-area {
        flex: 1;
        width: 100%;
        min-height: 0;
        padding: 0.75rem;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8rem;
        line-height: 1.6;
        color: var(--fg);
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        resize: none;
        outline: none;
        overflow-y: auto;
      }
      .input-area:focus {
        border-color: var(--purple);
      }
      .input-area::placeholder {
        color: var(--muted);
      }
      .input-stats {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        flex-shrink: 0;
      }
      .input-stats .valid {
        color: var(--green);
      }
      .input-stats .invalid {
        color: var(--red);
      }
      .generate-btn {
        margin-top: 0.5rem;
        padding: 0.6rem 1.25rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--bg);
        background: var(--gold);
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
      }
      .generate-btn:hover {
        transform: translateY(-1px);
      }
      .generate-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Center Panel - Pipeline */
      .pipeline {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        min-height: 0;
        overflow-y: auto;
      }
      .pipeline-step {
        padding: 0.6rem;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 0.7rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        transition: all 0.3s;
        flex-shrink: 0;
      }
      .pipeline-step.active {
        border-color: var(--gold);
        background: rgba(251, 191, 36, 0.05);
      }
      .pipeline-step.done {
        border-color: var(--green);
        background: rgba(74, 222, 128, 0.05);
      }
      .pipeline-step.error {
        border-color: var(--red);
        background: rgba(248, 113, 113, 0.05);
      }
      .step-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .step-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        flex-shrink: 0;
      }
      .pipeline-step.active .step-icon {
        background: var(--gold);
        color: var(--bg);
      }
      .pipeline-step.done .step-icon {
        background: var(--green);
        color: var(--bg);
      }
      .pipeline-step.error .step-icon {
        background: var(--red);
        color: var(--bg);
      }
      .step-label {
        flex: 1;
        color: var(--muted);
      }
      .pipeline-step.active .step-label,
      .pipeline-step.done .step-label {
        color: var(--fg);
      }
      .step-time {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.65rem;
        color: var(--muted);
        padding-left: 28px;
        margin-top: -0.25rem;
      }

      .pipeline-connector {
        width: 1px;
        height: 8px;
        background: var(--border);
        margin-left: 10px;
        flex-shrink: 0;
      }

      /* Right Panel - Output */
      .output-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow-y: auto;
        gap: 1.5rem;
      }
      .output-image {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        background: var(--card);
        border: none;
        border-radius: 0.75rem;
        display: none;
        flex-shrink: 0;
      }
      .output-image.visible {
        display: block;
      }
      .image-placeholder {
        width: 100%;
        aspect-ratio: 1;
        background: var(--card);
        border: none;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 0.75rem;
        flex-shrink: 0;
      }
      .output-title {
        font-size: 1.5rem;
        font-weight: 300;
        color: var(--fg);
        text-align: center;
        letter-spacing: 0.02em;
        line-height: 1.4;
        margin: 0;
        flex-shrink: 0;
      }
      .output-reflection {
        font-size: 0.9rem;
        line-height: 1.8;
        color: rgba(250, 250, 250, 0.95);
        white-space: pre-wrap;
        flex-shrink: 0;
      }

      /* Chat Section */
      .chat-section {
        display: flex;
        flex-direction: column;
        padding-top: 1rem;
        flex-shrink: 0;
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        min-height: 0;
      }
      .chat-message {
        padding: 0.6rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        line-height: 1.5;
        flex-shrink: 0;
      }
      .chat-message.user {
        background: var(--card);
        border: 1px solid var(--border);
        margin-left: 2rem;
      }
      .chat-message.anky {
        background: rgba(251, 191, 36, 0.05);
        border: 1px solid rgba(251, 191, 36, 0.2);
        margin-right: 2rem;
      }
      .chat-input-wrapper {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        font-family: "Inter", sans-serif;
        font-size: 0.85rem;
        color: var(--fg);
        background: rgba(17, 17, 19, 0.5);
        border: 1px solid rgba(31, 31, 35, 0.5);
        border-radius: 2rem;
        outline: none;
        transition: all 0.2s;
      }
      .chat-input:focus {
        background: var(--card);
        border-color: rgba(251, 191, 36, 0.3);
      }
      .chat-input::placeholder {
        color: var(--muted);
      }
      .chat-send {
        padding: 0.75rem;
        font-size: 0.85rem;
        font-weight: 400;
        color: var(--muted);
        background: transparent;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        flex-shrink: 0;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      .chat-send:hover {
        color: var(--gold);
        background: rgba(251, 191, 36, 0.1);
      }
      .chat-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Loading spinner */
      .spinner {
        width: 12px;
        height: 12px;
        border: 2px solid var(--border);
        border-top-color: var(--gold);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <!-- Left Panel: Input -->
      <div class="panel">
        <div class="panel-header">
          <span>input</span>
          <span style="color: var(--purple)">paste only</span>
        </div>
        <textarea
          class="input-area"
          id="inputArea"
          placeholder="paste an anky here (300+ words required)"
        ></textarea>
        <div class="input-stats">
          <span id="wordCount" class="invalid">0 words</span>
          <span id="charCount">0 chars</span>
        </div>
        <button class="generate-btn" id="generateBtn" disabled>
          generate anky
        </button>
      </div>

      <!-- Center Panel: Pipeline -->
      <div class="panel">
        <div class="panel-header">pipeline</div>
        <div class="pipeline" id="pipeline">
          <div class="pipeline-step" data-step="prompt">
            <div class="step-content">
              <div class="step-icon">1</div>
              <span class="step-label">image prompt</span>
            </div>
            <span class="step-time" id="time-prompt">—</span>
          </div>
          <div class="pipeline-connector"></div>
          <div class="pipeline-step" data-step="reflection">
            <div class="step-content">
              <div class="step-icon">2</div>
              <span class="step-label">reflection</span>
            </div>
            <span class="step-time" id="time-reflection">—</span>
          </div>
          <div class="pipeline-connector"></div>
          <div class="pipeline-step" data-step="image">
            <div class="step-content">
              <div class="step-icon">3</div>
              <span class="step-label">generate image</span>
            </div>
            <span class="step-time" id="time-image">—</span>
          </div>
          <div class="pipeline-connector"></div>
          <div class="pipeline-step" data-step="title">
            <div class="step-content">
              <div class="step-icon">4</div>
              <span class="step-label">title</span>
            </div>
            <span class="step-time" id="time-title">—</span>
          </div>
          <div class="pipeline-connector"></div>
          <div class="pipeline-step" data-step="ipfs">
            <div class="step-content">
              <div class="step-icon">5</div>
              <span class="step-label">ipfs upload</span>
            </div>
            <span class="step-time" id="time-ipfs">—</span>
          </div>
        </div>
      </div>

      <!-- Right Panel: Output + Chat -->
      <div class="panel">
        <div class="panel-header">output</div>

        <div class="output-content">
          <div class="image-placeholder" id="imagePlaceholder">
            waiting for generation...
          </div>
          <img
            class="output-image"
            id="outputImage"
            src=""
            alt="Generated Anky"
          />

          <div class="output-title" id="outputTitle">—</div>

          <div class="output-reflection" id="outputReflection">—</div>

          <div class="chat-section" id="chatSection" style="display: none">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-wrapper">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="continue with anky..."
              />
              <button class="chat-send" id="chatSend">→</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      const inputArea = document.getElementById("inputArea");
      const wordCountEl = document.getElementById("wordCount");
      const charCountEl = document.getElementById("charCount");
      const generateBtn = document.getElementById("generateBtn");
      const outputImage = document.getElementById("outputImage");
      const imagePlaceholder = document.getElementById("imagePlaceholder");
      const outputTitle = document.getElementById("outputTitle");
      const outputReflection = document.getElementById("outputReflection");
      const chatSection = document.getElementById("chatSection");
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const chatSend = document.getElementById("chatSend");

      let currentAnkyData = null;
      let chatHistory = [];

      // ============================================
      // PASTE-ONLY INPUT
      // ============================================
      inputArea.addEventListener("keydown", (e) => {
        // Allow: Ctrl+V, Cmd+V, Ctrl+A, Cmd+A
        const isPaste = (e.ctrlKey || e.metaKey) && e.key === "v";
        const isSelectAll = (e.ctrlKey || e.metaKey) && e.key === "a";

        if (!isPaste && !isSelectAll) {
          e.preventDefault();
        }
      });

      inputArea.addEventListener("input", () => {
        updateStats();
      });

      inputArea.addEventListener("paste", () => {
        setTimeout(updateStats, 0);
      });

      function updateStats() {
        const text = inputArea.value.trim();
        const words = text ? text.split(/\s+/).filter(Boolean).length : 0;
        const chars = text.length;

        wordCountEl.textContent = `${words} words`;
        charCountEl.textContent = `${chars} chars`;

        if (words >= 300) {
          wordCountEl.classList.remove("invalid");
          wordCountEl.classList.add("valid");
          generateBtn.disabled = false;
        } else {
          wordCountEl.classList.remove("valid");
          wordCountEl.classList.add("invalid");
          generateBtn.disabled = true;
        }
      }

      // ============================================
      // PIPELINE VISUALIZATION
      // ============================================
      function resetPipeline() {
        document.querySelectorAll(".pipeline-step").forEach((step) => {
          step.classList.remove("active", "done", "error");
        });
        document.querySelectorAll(".step-time").forEach((time) => {
          time.textContent = "—";
        });
      }

      function setStepActive(stepName) {
        const step = document.querySelector(`[data-step="${stepName}"]`);
        if (step) {
          step.classList.add("active");
          const stepContent = step.querySelector(".step-content");
          if (stepContent) {
            stepContent.querySelector(".step-icon").innerHTML =
              '<div class="spinner"></div>';
          }
        }
      }

      function setStepDone(stepName, timeMs) {
        const step = document.querySelector(`[data-step="${stepName}"]`);
        if (step) {
          step.classList.remove("active");
          step.classList.add("done");
          const stepContent = step.querySelector(".step-content");
          if (stepContent) {
            stepContent.querySelector(".step-icon").textContent = "✓";
          }
          document.getElementById(
            `time-${stepName}`
          ).textContent = `${timeMs}ms`;
        }
      }

      function setStepError(stepName, error) {
        const step = document.querySelector(`[data-step="${stepName}"]`);
        if (step) {
          step.classList.remove("active");
          step.classList.add("error");
          const stepContent = step.querySelector(".step-content");
          if (stepContent) {
            stepContent.querySelector(".step-icon").textContent = "✗";
          }
          document.getElementById(`time-${stepName}`).textContent = "error";
        }
      }

      // ============================================
      // GENERATION (Step by Step)
      // ============================================
      generateBtn.addEventListener("click", async () => {
        const text = inputArea.value.trim();
        if (!text) return;

        generateBtn.disabled = true;
        generateBtn.textContent = "generating...";
        resetPipeline();

        outputImage.classList.remove("visible");
        imagePlaceholder.style.display = "flex";
        imagePlaceholder.textContent = "generating...";
        outputTitle.textContent = "—";
        outputReflection.textContent = "—";
        chatSection.style.display = "none";
        chatHistory = [];
        chatMessages.innerHTML = "";

        try {
          // Step 1 & 2: Parallel - Image Prompt + Reflection
          setStepActive("prompt");
          setStepActive("reflection");

          const startParallel = Date.now();

          const [promptResult, reflectionResult] = await Promise.all([
            fetchStep("/api/test/prompt", { writingSession: text }),
            fetchStep("/api/test/reflection", {
              writingSession: text,
              locale: navigator.language,
            }),
          ]);

          const parallelTime = Date.now() - startParallel;
          setStepDone("prompt", parallelTime);
          setStepDone("reflection", parallelTime);

          // Step 3: Generate Image
          setStepActive("image");
          const imageStart = Date.now();
          const imageResult = await fetchStep("/api/test/image", {
            prompt: promptResult.prompt,
          });
          setStepDone("image", Date.now() - imageStart);

          // Show image immediately
          outputImage.src = imageResult.url;
          outputImage.classList.add("visible");
          imagePlaceholder.style.display = "none";

          // Step 4: Generate Title
          setStepActive("title");
          const titleStart = Date.now();
          const titleResult = await fetchStep("/api/test/title", {
            writingSession: text,
            imagePrompt: promptResult.prompt,
            reflection: reflectionResult.reflection,
          });
          setStepDone("title", Date.now() - titleStart);

          // Show title
          outputTitle.textContent = titleResult.title;

          // Show reflection
          outputReflection.textContent = reflectionResult.reflection;

          // Step 5: IPFS (optional)
          setStepActive("ipfs");
          const ipfsStart = Date.now();
          try {
            const ipfsResult = await fetchStep("/api/test/ipfs", {
              writingSession: text,
              imageBase64: imageResult.base64,
              title: titleResult.title,
              reflection: reflectionResult.reflection,
              imagePrompt: promptResult.prompt,
            });
            setStepDone("ipfs", Date.now() - ipfsStart);

            currentAnkyData = {
              writingSession: text,
              ...promptResult,
              ...reflectionResult,
              ...imageResult,
              ...titleResult,
              ...ipfsResult,
            };
          } catch (e) {
            // IPFS is optional
            setStepError("ipfs", e.message);
            currentAnkyData = {
              writingSession: text,
              ...promptResult,
              ...reflectionResult,
              ...imageResult,
              ...titleResult,
            };
          }

          // Show chat
          chatSection.style.display = "flex";
        } catch (e) {
          console.error("Generation failed:", e);
          imagePlaceholder.textContent = `Error: ${e.message}`;
        }

        generateBtn.disabled = false;
        generateBtn.textContent = "generate anky";
      });

      async function fetchStep(url, body) {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(error);
        }

        return response.json();
      }

      // ============================================
      // CHAT WITH ANKY
      // ============================================
      chatSend.addEventListener("click", sendMessage);
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || !currentAnkyData) return;

        // Add user message
        chatHistory.push({ role: "user", content: message });
        addMessageToChat("user", message);
        chatInput.value = "";
        chatSend.disabled = true;

        try {
          const response = await fetch("/api/test/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              writingSession: currentAnkyData.writingSession,
              reflection: currentAnkyData.reflection,
              title: currentAnkyData.title,
              history: chatHistory,
            }),
          });

          const data = await response.json();

          chatHistory.push({ role: "assistant", content: data.response });
          addMessageToChat("anky", data.response);
        } catch (e) {
          addMessageToChat("anky", `Error: ${e.message}`);
        }

        chatSend.disabled = false;
        chatInput.focus();
      }

      function addMessageToChat(role, content) {
        const div = document.createElement("div");
        div.className = `chat-message ${role}`;
        div.textContent = content;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    </script>
  </body>
</html>
